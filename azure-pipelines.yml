# TP07 - Coverage, SonarCloud, Deploy to QA and Cypress E2E tests
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '20.x'  
  azureSubscription: 'azure-palabras-connection' 
  webAppNameQA: 'palabras-qa' 
  webAppNamePROD: 'palabras-prod' 

# =======================================
# STAGE 1: Build and Test Backend + Frontend
# =======================================
stages:
- stage: BuildAndTest
  displayName: "Build & Test Backend + Frontend"
  jobs:
    - job: BuildAndTest
      displayName: 'Test, Coverage, and Build Job'
      steps:
        - checkout: self
          fetchDepth: 0

        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        # ===============================================
        # BACKEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm ci
          displayName: "Backend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Backend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        # Publicar resultados de tests del backend
        - task: PublishTestResults@2
          displayName: "Publish Backend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/backend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Backend Unit Tests'

        # Publicar coverage del backend
        - task: PublishCodeCoverageResults@2
          displayName: "Publish Backend Coverage"
          condition: succeededOrFailed()
          inputs:
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage/cobertura-coverage.xml'
            pathToSources: '$(System.DefaultWorkingDirectory)/backend'
            failIfCoverageEmpty: true

        # Verificar threshold del backend (Jest ya falla si no cumple)
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            
            # Extraer el porcentaje del archivo json-summary
            if [ -f "coverage/coverage-summary.json" ]; then
              LINES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['lines']['pct'])")
              STATEMENTS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['statements']['pct'])")
              FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['functions']['pct'])")
              BRANCHES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['branches']['pct'])")
              
              echo "Lines: ${LINES_PCT}%"
              echo "Statements: ${STATEMENTS_PCT}%"
              echo "Functions: ${FUNCTIONS_PCT}%"
              echo "Branches: ${BRANCHES_PCT}%"
              
              # Calcular promedio
              AVG=$(python3 -c "print(round((${LINES_PCT} + ${STATEMENTS_PCT} + ${FUNCTIONS_PCT} + ${BRANCHES_PCT}) / 4, 2))")
              echo "Average Coverage: ${AVG}%"
              
              # Verificar threshold
              if (( $(echo "${AVG} < 70" | bc -l) )); then
                echo "âŒ Backend coverage (${AVG}%) is below 70%"
                exit 1
              fi
              
              echo "âœ… Backend coverage (${AVG}%) meets the 70% requirement"
            else
              echo "âŒ Coverage summary file not found"
              exit 1
            fi
          displayName: "Backend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        # ===============================================
        # FRONTEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm ci
          displayName: "Frontend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Frontend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        # Publicar resultados de tests del frontend
        - task: PublishTestResults@2
          displayName: "Publish Frontend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/frontend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Frontend Unit Tests'

        # Publicar coverage del frontend
        - task: PublishCodeCoverageResults@2
          displayName: "Publish Frontend Coverage"
          condition: succeededOrFailed()
          inputs:
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml'
            pathToSources: '$(System.DefaultWorkingDirectory)/frontend'
            failIfCoverageEmpty: true

        # Verificar threshold del frontend
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            
            if [ -f "coverage/coverage-summary.json" ]; then
              LINES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['lines']['pct'])")
              STATEMENTS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['statements']['pct'])")
              FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['functions']['pct'])")
              BRANCHES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['branches']['pct'])")
              
              echo "Lines: ${LINES_PCT}%"
              echo "Statements: ${STATEMENTS_PCT}%"
              echo "Functions: ${FUNCTIONS_PCT}%"
              echo "Branches: ${BRANCHES_PCT}%"
              
              AVG=$(python3 -c "print(round((${LINES_PCT} + ${STATEMENTS_PCT} + ${FUNCTIONS_PCT} + ${BRANCHES_PCT}) / 4, 2))")
              echo "Average Coverage: ${AVG}%"
              
              if (( $(echo "${AVG} < 70" | bc -l) )); then
                echo "âŒ Frontend coverage (${AVG}%) is below 70%"
                exit 1
              fi
              
              echo "âœ… Frontend coverage (${AVG}%) meets the 70% requirement"
            else
              echo "âŒ Coverage summary file not found"
              exit 1
            fi
          displayName: "Frontend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        - task: SonarCloudPrepare@3
          inputs:
            SonarQube: 'sonar-cloud-connection'
            organization: 'sofiaoliveto'
            scannerMode: 'cli'
            configMode: 'file'
            cliProjectKey: 'sofiaoliveto_TP7'
            cliProjectName: 'TP7'
            cliSources: '.'

        # ===============================================
        # BUILD Y PREPARAR ARTEFACTOS
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND BUILD"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm run build
            echo "âœ… Backend build completed"
          displayName: "Build Backend"

        - task: CopyFiles@2
          displayName: 'Copy Frontend to Backend'
          inputs:
            SourceFolder: 'frontend'
            Contents: |
              index.html
              app.js
              styles.css
            TargetFolder: 'backend/frontend'
            OverWrite: true

        - task: SonarCloudAnalyze@3
          inputs:
            jdkversion: 'JAVA_HOME_17_X64'

        - task: SonarCloudPublish@3
          inputs:
            pollingTimeoutSec: '300'

        # ARCHIVE APPLICATION FILES
        - task: ArchiveFiles@2
          displayName: 'Archive Application Files'
          condition: succeeded()
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)/backend'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
            replaceExistingArchive: true
            verbose: true

        # PUBLISH BUILD ARTIFACTS
        - task: PublishBuildArtifacts@1
          displayName: 'Publish Application Artifact'
          condition: succeeded()
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: 'drop'
            publishLocation: 'Container'

# =======================================
# STAGE 2: Deploy QA and Cypress tests
# =======================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: BuildAndTest
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  variables:
  - group: QA-Variables
    #
    # JOB 1: Deploy to Azure QA
    #
  jobs:
    - deployment: DeployToAzureQA
      displayName: 'Deploy to QA'
      environment: 'QA'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@1
                displayName: 'Download Artifacts'
                inputs:
                  buildType: 'current'
                  downloadType: 'single'
                  artifactName: 'drop'
                  downloadPath: '$(System.ArtifactsDirectory)'

              # Configurar variables de entorno
              - task: AzureAppServiceSettings@1
                displayName: "Configure QA Environment Variables"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appName: "$(webAppNameQA)"
                  resourceGroupName: "palabras-ingsoft3-2025"
                  appSettings: |
                    [
                      { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
                      { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
                      { "name": "DB_PATH", "value": "$(DB_PATH)" }
                    ]

              - task: AzureWebApp@1
                displayName: 'Deploy to QA'
                inputs:
                  azureSubscription: '$(azureSubscription)'
                  appType: 'webAppLinux'
                  appName: '$(webAppNameQA)'
                  package: '$(System.ArtifactsDirectory)/drop/$(Build.BuildId).zip'
                  runtimeStack: 'NODE|20-lts'
                  startUpCommand: 'node index.js'

              - script: |
                  echo "Waiting for health endpoint to respond..."
                  url="https://palabras-qa-gebud8fdgxejeyen.brazilsouth-01.azurewebsites.net/health"
                  timeout=120
                  interval=5
                  elapsed=0
                  until curl -sSf "$url" > /dev/null; do
                    sleep $interval
                    elapsed=$((elapsed + interval))
                    echo "Waiting... ${elapsed}s elapsed"
                    if [ $elapsed -ge $timeout ]; then
                      echo "Health check timed out after ${timeout}s"
                      exit 1
                    fi
                  done
                  echo "âœ… Health endpoint is OK: $url"
                displayName: 'Wait for /health (QA)'
                condition: succeeded()

    #
    # JOB 2: Cypress Integration Tests
    #
    - job: CypressIntegrationTests
      displayName: 'Cypress Integration Tests'
      dependsOn: DeployToAzureQA
      condition: succeeded()
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self
          fetchDepth: 0

        - task: NodeTool@0
          displayName: 'Install Node.js $(nodeVersion)'
          inputs:
            versionSpec: $(nodeVersion)

        - script: |
            echo "ğŸ“¦ Installing Cypress + E2E dependencies"
            npm ci
            npm install --save-dev cypress wait-on @faker-js/faker
            npx cypress install || true
          displayName: 'Install Cypress + project deps'

        - script: |
            echo "ğŸŒ Esperando a que la app QA estÃ© online..."
            URL="https://palabras-qa-gebud8fdgxejeyen.brazilsouth-01.azurewebsites.net"
            npx wait-on "$URL"
          displayName: 'Wait for deployed QA app to be ready'

        - script: |
            echo "=== Running Cypress E2E Tests ==="
            cd $(System.DefaultWorkingDirectory)
            ls -la
            npx cypress run \
              --browser chromium --headless \
              --reporter junit \
              --reporter-options "mochaFile=cypress/results/junit-[hash].xml,toConsole=true" \
              --config-file cypress.config.js \
              --config baseUrl=https://palabras-qa-gebud8fdgxejeyen.brazilsouth-01.azurewebsites.net,pageLoadTimeout=120000,defaultCommandTimeout=15000
          displayName: 'Run Cypress E2E Tests'
          env:
            NODE_ENV: test
            CI: true

        - task: PublishTestResults@2
          displayName: 'Publish Cypress E2E Test Results'
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: 'cypress/results/*.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Cypress E2E Tests - $(Build.BuildNumber)'
            publishRunAttachments: true