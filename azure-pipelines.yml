# TP05 - Azure DevOps CI/CD Pipeline - Aplicaci√≥n Palabras (Node.js)
# Basado en arquitectura similar: Backend (Node.js) + Frontend (HTML/JS est√°ticos)

# Trigger desactivado: el pipeline solo se ejecutar√° manualmente
trigger: none

# Pool de agentes: Ubuntu m√°s reciente para mejor compatibilidad con Node.js
pool:
  vmImage: 'ubuntu-latest'

# Variables globales del pipeline
variables:
  nodeVersion: '20.x'  
  azureSubscription: 'azure-palabras-connection' 
  webAppNameQA: 'palabras-qa' 
  webAppNamePROD: 'palabras-prod' 

stages:
# =======================================
# üß± BUILD & TEST
# =======================================
- stage: BuildAndTest
  displayName: "Build & Test Backend + Frontend"
  jobs:
    - job: BuildAndTest
      displayName: 'Build and Test Job'
      steps:
        # Obtener c√≥digo fuente del repositorio
        - checkout: self

        # ---- Setup Node.js ----
        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        # ---- Backend (Node.js + Express) ----
        # Instala dependencias y ejecuta build del backend
        - script: |
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "  BACKEND BUILD"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            cd backend
            # npm ci es m√°s r√°pido y confiable para CI/CD que npm install
            npm ci
            npm run build
            echo "‚úÖ Backend build completed"
          displayName: "Build Backend"

        # ---- Frontend (Static HTML/JS) ----
        # Prepara archivos est√°ticos del frontend
        - script: |
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "  FRONTEND BUILD"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            cd frontend
            # Frontend no requiere build, solo verificaci√≥n
            # Instala dependencias solo si existe package.json
            if [ -f "package.json" ]; then
              npm ci --if-present
              npm run build --if-present
            fi
            echo "‚úÖ Frontend ready"
          displayName: "Prepare Frontend"

        # ---- Copiar Frontend al Backend ----
        # Integra los archivos del frontend dentro del backend para deployment conjunto
        - task: CopyFiles@2
          displayName: 'Copy Frontend to Backend'
          inputs:
            SourceFolder: 'frontend'
            Contents: |
              index.html
              app.js
              styles.css
            TargetFolder: 'backend/frontend'
            OverWrite: true

        # ---- Publicar Backend + Frontend juntos ----
        # Prepara el paquete final que se deployar√°
        - script: |
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "  PREPARING PUBLISH PACKAGE"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            mkdir -p "$(Build.ArtifactStagingDirectory)/publish"
            
            # Copiar archivos esenciales del backend
            cp backend/index.js "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package.json "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package-lock.json "$(Build.ArtifactStagingDirectory)/publish/"
            # node_modules necesario para runtime en Azure App Service
            cp -r backend/node_modules "$(Build.ArtifactStagingDirectory)/publish/"
            
            # Copiar frontend que ya est√° integrado dentro de backend
            cp -r backend/frontend "$(Build.ArtifactStagingDirectory)/publish/"
            
            # Copiar base de datos SQLite si existe
            if [ -f "backend/palabras.db" ]; then
              cp backend/palabras.db "$(Build.ArtifactStagingDirectory)/publish/"
            fi
            
            # Mostrar estructura final del paquete para debug
            echo ""
            echo "‚úÖ Package structure:"
            ls -lah "$(Build.ArtifactStagingDirectory)/publish/"
            echo ""
            echo "üìÅ Frontend files:"
            ls -lah "$(Build.ArtifactStagingDirectory)/publish/frontend/"
            echo ""
            echo "üìÑ Backend index.js (first 5 lines):"
            head -n 5 "$(Build.ArtifactStagingDirectory)/publish/index.js"
          displayName: "Publish Backend+Frontend"

        # ---- Publicar Artefacto ----
        # Guarda el paquete como artefacto para las siguientes etapas
        - task: PublishBuildArtifacts@1
          displayName: "Publish Build Artifact"
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)/publish"
            ArtifactName: "drop"
            publishLocation: 'Container'

    # ---- NUEVO JOB: Unit Tests ----
    - job: UnitTests
      displayName: 'Run Unit Tests'
      dependsOn: BuildAndTest
      steps:
        - checkout: self

        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        - script: |
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo "  RUNNING UNIT TESTS (BACKEND + FRONTEND)"
            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

            # BACKEND UNIT TESTS
            echo "-> Backend tests"
            cd backend
            npm ci
            npm test -- --ci --reporters=default --reporters=jest-junit || BACKEND_RESULT=$?
            cd ..

            # FRONTEND UNIT TESTS (solo si existen)
            echo "-> Frontend tests (if defined)"
            if [ -f "frontend/package.json" ]; then
              node -e "try{process.exit(!(require('./frontend/package.json').scripts && require('./frontend/package.json').scripts.test))}catch(e){process.exit(1)}"
              if [ $? -eq 0 ]; then
                echo "Frontend has test script. Running frontend tests..."
                cd frontend
                npm ci --if-present
                npm test -- --ci --reporters=default --reporters=jest-junit || FRONTEND_RESULT=$?
                cd ..
              else
                echo "No 'test' script in frontend/package.json - skipping frontend tests."
              fi
            else
              echo "No frontend/package.json found - skipping frontend tests."
            fi

            # Salida si alguno fall√≥
            if [ -n "$BACKEND_RESULT" ] || [ -n "$FRONTEND_RESULT" ]; then
              echo "One or more unit tests failed."
              exit 1
            fi

            echo "‚úÖ Unit tests completed"
          displayName: "Execute Unit Tests"
          env:
            NODE_ENV: 'test'

        # Publicar resultados de tests del backend
        - task: PublishTestResults@2
          displayName: "Publish Backend Unit Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/backend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Backend Unit Tests'

        # Publicar resultados de tests del frontend (si existen)
        - task: PublishTestResults@2
          displayName: "Publish Frontend Unit Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/frontend'
            mergeTestResults: true
            failTaskOnFailedTests: false
            testRunTitle: 'Frontend Unit Tests'

# =======================================
# üåê DEPLOY QA
# =======================================
- stage: Deploy_QA
  displayName: "Deploy to QA"
  dependsOn: 
    - BuildAndTest
    - UnitTests
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  # Importar variables de QA
  variables:
  - group: QA-Variables
  jobs:
    - deployment: DeployQA
      displayName: "Desplegar QA"
      environment: "QA"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              
              - download: current
                artifact: drop

              # Configurar variables de entorno
              - task: AzureAppServiceSettings@1
                displayName: "Configure QA Environment Variables"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appName: "$(webAppNameQA)"
                  resourceGroupName: "palabras-ingsoft3-2025"
                  appSettings: |
                    [
                      { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
                      { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
                      { "name": "DB_PATH", "value": "$(DB_PATH)" }
                    ]

              - task: AzureWebApp@1
                displayName: "Deploy Backend+Frontend QA"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appType: 'webAppLinux'
                  appName: "$(webAppNameQA)"
                  package: "$(Pipeline.Workspace)/drop"
                  runtimeStack: 'NODE|20-lts'
                  startUpCommand: 'node index.js'

              - script: |
                  echo "‚è≥ Esperando 30 segundos..."
                  sleep 30
                  echo "üîç Verificando QA: $(ENVIRONMENT_NAME)"
                  curl -f https://palabras-qa-gebud8fdgxejeyen.brazilsouth-01.azurewebsites.net/health || echo "‚ö†Ô∏è Health check pending"
                displayName: "Health Check QA"
                continueOnError: true

# =======================================
# üöÄ DEPLOY PROD
# =======================================
- stage: Deploy_PROD
  displayName: "Deploy to Production"
  dependsOn: Deploy_QA
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  # Importar variables de PROD
  variables:
  - group: PROD-Variables
  jobs:
    - deployment: DeployPROD
      displayName: "Desplegar PROD"
      environment: "PROD"
      strategy:
        runOnce:
          deploy:
            steps:
              - checkout: self
              
              - download: current
                artifact: drop

              # Configurar variables de entorno
              - task: AzureAppServiceSettings@1
                displayName: "Configure PROD Environment Variables"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appName: "$(webAppNamePROD)"  
                  resourceGroupName: "palabras-ingsoft3-2025"
                  appSettings: |
                    [
                      { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
                      { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
                      { "name": "DB_PATH", "value": "$(DB_PATH)" }
                    ]

              - task: AzureWebApp@1
                displayName: "Deploy Backend+Frontend PROD"
                inputs:
                  azureSubscription: "$(azureSubscription)"
                  appType: 'webAppLinux'
                  appName: "$(webAppNamePROD)"
                  package: "$(Pipeline.Workspace)/drop"
                  runtimeStack: 'NODE|20-lts'
                  startUpCommand: 'node index.js'

              - script: |
                  echo "‚è≥ Esperando 30 segundos..."
                  sleep 30
                  echo "üîç Verificando PROD: $(ENVIRONMENT_NAME)"
                  curl -f https://palabras-prod-amgufubhacevetcn.brazilsouth-01.azurewebsites.net/health || echo "‚ö†Ô∏è Health check pending"
                displayName: "Health Check PROD"
                continueOnError: true