# TP07 - Coverage y mas!!
trigger: none

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeVersion: '20.x'  
  azureSubscription: 'azure-palabras-connection' 
  webAppNameQA: 'palabras-qa' 
  webAppNamePROD: 'palabras-prod' 

stages:
- stage: BuildAndTest
  displayName: "Build & Test Backend + Frontend"
  jobs:
    - job: BuildAndTest
      displayName: 'Test, Coverage, and Build Job'
      steps:
        - checkout: self
          fetchDepth: 0

        - task: NodeTool@0
          displayName: "Setup Node.js $(nodeVersion)"
          inputs:
            versionSpec: "$(nodeVersion)"

        # ===============================================
        # BACKEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm ci
          displayName: "Backend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Backend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        # Publicar resultados de tests del backend
        - task: PublishTestResults@2
          displayName: "Publish Backend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/backend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Backend Unit Tests'

        # Publicar coverage del backend
        - task: PublishCodeCoverageResults@1
          displayName: "Publish Backend Coverage"
          condition: succeededOrFailed()
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/backend/coverage/cobertura-coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/backend/coverage'
            failIfCoverageEmpty: false

        # Verificar threshold del backend (Jest ya falla si no cumple)
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            
            # Extraer el porcentaje del archivo json-summary
            if [ -f "coverage/coverage-summary.json" ]; then
              LINES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['lines']['pct'])")
              STATEMENTS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['statements']['pct'])")
              FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['functions']['pct'])")
              BRANCHES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['branches']['pct'])")
              
              echo "Lines: ${LINES_PCT}%"
              echo "Statements: ${STATEMENTS_PCT}%"
              echo "Functions: ${FUNCTIONS_PCT}%"
              echo "Branches: ${BRANCHES_PCT}%"
              
              # Calcular promedio
              AVG=$(python3 -c "print(round((${LINES_PCT} + ${STATEMENTS_PCT} + ${FUNCTIONS_PCT} + ${BRANCHES_PCT}) / 4, 2))")
              echo "Average Coverage: ${AVG}%"
              
              # Verificar threshold
              if (( $(echo "${AVG} < 70" | bc -l) )); then
                echo "âŒ Backend coverage (${AVG}%) is below 70%"
                exit 1
              fi
              
              echo "âœ… Backend coverage (${AVG}%) meets the 70% requirement"
            else
              echo "âŒ Coverage summary file not found"
              exit 1
            fi
          displayName: "Backend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        # ===============================================
        # FRONTEND: Tests + Coverage
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Installing dependencies"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm ci
          displayName: "Frontend - Install Dependencies"

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Running tests with coverage"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            npm test -- --coverage --ci --maxWorkers=2
          displayName: "Frontend - Unit Tests + Coverage"
          env:
            NODE_ENV: 'test'

        # Publicar resultados de tests del frontend
        - task: PublishTestResults@2
          displayName: "Publish Frontend Test Results"
          condition: succeededOrFailed()
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/junit.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/frontend'
            mergeTestResults: true
            failTaskOnFailedTests: true
            testRunTitle: 'Frontend Unit Tests'

        # Publicar coverage del frontend
        - task: PublishCodeCoverageResults@1
          displayName: "Publish Frontend Coverage"
          condition: succeededOrFailed()
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/frontend/coverage/cobertura-coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/frontend/coverage'
            failIfCoverageEmpty: false

        # Verificar threshold del frontend
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  FRONTEND: Verifying coverage threshold"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd frontend
            
            if [ -f "coverage/coverage-summary.json" ]; then
              LINES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['lines']['pct'])")
              STATEMENTS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['statements']['pct'])")
              FUNCTIONS_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['functions']['pct'])")
              BRANCHES_PCT=$(cat coverage/coverage-summary.json | python3 -c "import sys, json; print(json.load(sys.stdin)['total']['branches']['pct'])")
              
              echo "Lines: ${LINES_PCT}%"
              echo "Statements: ${STATEMENTS_PCT}%"
              echo "Functions: ${FUNCTIONS_PCT}%"
              echo "Branches: ${BRANCHES_PCT}%"
              
              AVG=$(python3 -c "print(round((${LINES_PCT} + ${STATEMENTS_PCT} + ${FUNCTIONS_PCT} + ${BRANCHES_PCT}) / 4, 2))")
              echo "Average Coverage: ${AVG}%"
              
              if (( $(echo "${AVG} < 70" | bc -l) )); then
                echo "âŒ Frontend coverage (${AVG}%) is below 70%"
                exit 1
              fi
              
              echo "âœ… Frontend coverage (${AVG}%) meets the 70% requirement"
            else
              echo "âŒ Coverage summary file not found"
              exit 1
            fi
          displayName: "Frontend - Verify Coverage Threshold"
          condition: succeededOrFailed()

        # ===============================================
        # BUILD Y PREPARAR ARTEFACTOS
        # ===============================================
        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  BACKEND BUILD"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            cd backend
            npm run build
            echo "âœ… Backend build completed"
          displayName: "Build Backend"

        - task: CopyFiles@2
          displayName: 'Copy Frontend to Backend'
          inputs:
            SourceFolder: 'frontend'
            Contents: |
              index.html
              app.js
              styles.css
            TargetFolder: 'backend/frontend'
            OverWrite: true

        - script: |
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "  PREPARING PUBLISH PACKAGE"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            mkdir -p "$(Build.ArtifactStagingDirectory)/publish"
            
            cp backend/index.js "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/db.js "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package.json "$(Build.ArtifactStagingDirectory)/publish/"
            cp backend/package-lock.json "$(Build.ArtifactStagingDirectory)/publish/"
            cp -r backend/node_modules "$(Build.ArtifactStagingDirectory)/publish/"
            cp -r backend/frontend "$(Build.ArtifactStagingDirectory)/publish/"
            
            if [ -f "backend/palabras.db" ]; then
              cp backend/palabras.db "$(Build.ArtifactStagingDirectory)/publish/"
            fi
            
            echo "âœ… Package structure:"
            ls -lah "$(Build.ArtifactStagingDirectory)/publish/"
          displayName: "Publish Backend+Frontend"

        - task: PublishBuildArtifacts@1
          displayName: "Publish Build Artifact"
          inputs:
            PathtoPublish: "$(Build.ArtifactStagingDirectory)/publish"
            ArtifactName: "drop"
            publishLocation: 'Container'
            
            # =======================================
            # ğŸŒ DEPLOY QA (DESACTIVADO: BLOQUE COMENTADO)
            # =======================================
            # - stage: Deploy_QA
            #   displayName: "Deploy to QA"
            #   dependsOn: BuildAndTest
            #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            #   # Importar variables de QA
            #   variables:
            #   - group: QA-Variables
            #   jobs:
            #     - deployment: DeployQA
            #       displayName: "Desplegar QA"
            #       environment: "QA"
            #       strategy:
            #         runOnce:
            #           deploy:
            #             steps:
            #               - checkout: self
            #
            #               - download: current
            #                 artifact: drop
            #
            #               # Configurar variables de entorno
            #               - task: AzureAppServiceSettings@1
            #                 displayName: "Configure QA Environment Variables"
            #                 inputs:
            #                   azureSubscription: "$(azureSubscription)"
            #                   appName: "$(webAppNameQA)"
            #                   resourceGroupName: "palabras-ingsoft3-2025"
            #                   appSettings: |
            #                     [
            #                       { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
            #                       { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
            #                       { "name": "DB_PATH", "value": "$(DB_PATH)" }
            #                     ]
            #
            #               - task: AzureWebApp@1
            #                 displayName: "Deploy Backend+Frontend QA"
            #                 inputs:
            #                   azureSubscription: "$(azureSubscription)"
            #                   appType: 'webAppLinux'
            #                   appName: "$(webAppNameQA)"
            #                   package: "$(Pipeline.Workspace)/drop"
            #                   runtimeStack: 'NODE|20-lts'
            #                   startUpCommand: 'node index.js'
            #
            #               - script: |
            #                   echo "â³ Esperando 30 segundos..."
            #                   sleep 30
            #                   echo "ğŸ” Verificando QA: $(ENVIRONMENT_NAME)"
            #                   curl -f https://palabras-qa-gebud8fdgxejeyen.brazilsouth-01.azurewebsites.net/health || echo "âš ï¸ Health check pending"
            #                 displayName: "Health Check QA"
            #                 continueOnError: true
            #
            # =======================================
            # ğŸš€ DEPLOY PROD (DESACTIVADO: BLOQUE COMENTADO)
            # =======================================
            # - stage: Deploy_PROD
            #   displayName: "Deploy to Production"
            #   dependsOn: Deploy_QA
            #   condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            #   # Importar variables de PROD
            #   variables:
            #   - group: PROD-Variables
            #   jobs:
            #     - deployment: DeployPROD
            #       displayName: "Desplegar PROD"
            #       environment: "PROD"
            #       strategy:
            #         runOnce:
            #           deploy:
            #             steps:
            #               - checkout: self
            #                 
            #               
            #               - download: current
            #                 artifact: drop
            #
            #               # Configurar variables de entorno
            #               - task: AzureAppServiceSettings@1
            #                 displayName: "Configure PROD Environment Variables"
            #                 inputs:
            #                   azureSubscription: "$(azureSubscription)"
            #                   appName: "$(webAppNamePROD)"  
            #                   resourceGroupName: "palabras-ingsoft3-2025"
            #                   appSettings: |
            #                     [
            #                       { "name": "ENVIRONMENT_NAME", "value": "$(ENVIRONMENT_NAME)" },
            #                       { "name": "NODE_ENV", "value": "$(NODE_ENV)" },
            #                       { "name": "DB_PATH", "value": "$(DB_PATH)" }
            #                     ]
            #
            #               - task: AzureWebApp@1
            #                 displayName: "Deploy Backend+Frontend PROD"
            #                 inputs:
            #                   azureSubscription: "$(azureSubscription)"
            #                   appType: 'webAppLinux'
            #                   appName: "$(webAppNamePROD)"
            #                   package: "$(Pipeline.Workspace)/drop"
            #                   runtimeStack: 'NODE|20-lts'
            #                   startUpCommand: 'node index.js'
            #
            #               - script: |
            #                   echo "â³ Esperando 30 segundos..."
            #                   sleep 30
            #                   echo "ğŸ” Verificando PROD: $(ENVIRONMENT_NAME)"
            #                   curl -f https://palabras-prod-amgufubhacevetcn.brazilsouth-01.azurewebsites.net/health || echo "âš ï¸ Health check pending"
            #                 displayName: "Health Check PROD"
            #                 continueOnError: true
